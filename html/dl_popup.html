<link href="../css/popup.css" rel="stylesheet">
<div id="popup-container">
    <div id="popup-backdrop"></div>
    <div id="popup-flexbox">
        <div id="popup-window">
            <div><h2 class="popup-h2">Download List</h2></div>
            <div class="div-seperator-line"></div>
            <div id="popup-content">
                <div class="row-box">
                    <div class="row-elem">
                        <div class="clickable">
                            <input id="rdio-audio" class="no-margin" name="format" type="radio" value="" checked="checked"/><label for="rdio-audio" class="ltr-label">Audio (mp3/ogg)</label>
                        </div>
                    </div>
                    <div class="row-elem">
                        <div class="clickable">
                            <input id="rdio-video" class="no-margin" name="format" type="radio"/><label for="rdio-video" class="ltr-label">Video (mp4 only)</label>
                        </div>
                    </div>
                </div>
                <div class="row-box">
                    <div class="clickable row-elem">
                        <input id="chk-metadata" class="no-margin" name="metadata" type="checkbox"/><label for="chk-metadata" class="ltr-label">Write Metadata</label>
                    </div>
                    <select id="sel-metadata-type" name="metadata-type" class="clickable">
                        <option value="simple" title="Title: %AnimeName% OP">Anime Name OP Title</option>
                        <option value="advanced" title="Write title and artist of full song">Title and Artist (Anime Name in desc)</option>
                    </select>
                </div>
                <div class="row-box">
                    <select id="sel-ext" name="ext" class="clickable">
                        <option value="mp3">mp3</option>
                        <option value="ogg">ogg</option>
                    </select>
                </div>
            </div>
            <div class="div-seperator-line"></div>
            <div class="right-btn-box">
                <button id="cancel-btn" class="ext-btn menu-elem cancel-btn">Cancel</button><button id="apply-btn" class="ext-btn menu-elem apply-btn">Download</button>
            </div> 
        </div>
    </div>
</div>
<script> // for testing purposes only
    function closePopup(event) {
        if (!event || event.currentTarget == event.explicitOriginalTarget)
            document.getElementById("popup-container").remove();
    }
    function onClickDownloadBtn(event) {
        console.log("download started");
        closePopup(event);
    }
    function applyVideoMode() {
        fullDisableElem(document.getElementById("chk-metadata"));
        fullDisableElem(document.getElementById("sel-metadata-type"));
        let sel_ext = document.getElementById("sel-ext");
        fullDisableElem(sel_ext);
        while (sel_ext.firstChild)
            sel_ext.removeChild(sel_ext.firstChild);
        let opt_mp4 = document.createElement("option");
        opt_mp4.value = "mp4";
        opt_mp4.text = "mp4"
        sel_ext.append(opt_mp4);
    }
    function applyAudioMode() {
        fullEnableElem(document.getElementById("chk-metadata"));
        
        let sel_ext = document.getElementById("sel-ext");
        fullEnableElem(sel_ext);
        while (sel_ext.firstChild)
            sel_ext.removeChild(sel_ext.firstChild);
        let opt_mp3 = document.createElement("option");
        opt_mp3.value = "mp3";
        opt_mp3.text = "mp3";
        sel_ext.append(opt_mp3);
        let opt_ogg = document.createElement("option");
        opt_ogg.value = "ogg";
        opt_ogg.text = "ogg";
        sel_ext.append(opt_ogg);
        updateSelMetadataType();
    }
    function updateSelMetadataType() {
        let sel_metadata_type = document.getElementById("sel-metadata-type")
        if (document.getElementById("chk-metadata").checked)
            fullEnableElem(sel_metadata_type);
        else
            fullDisableElem(sel_metadata_type);
    }
    function fullDisableElem(elem) {
        elem.disabled = true;
        if (elem.tagName.toLowerCase() == "select")
            elem.className = elem.className.replace("clickable", "").trim().replace(new RegExp("\s{2,}", "gi"), " ");
        else
            elem.parentElement.className = elem.parentElement.className.replace("clickable", "").trim().replace(new RegExp("\s{2,}", "gi"), " ");
    }
    function fullEnableElem(elem) {
        elem.disabled = false;
        if (elem.tagName.toLowerCase() == "select")
            elem.className = elem.className.concat(" ", "clickable").trim();
        else
            elem.parentElement.className = elem.parentElement.className.concat(" ", "clickable").trim();
    }

    updateSelMetadataType();
    if (document.getElementById("rdio-video").checked)
        applyAudioMode();
    if (document.getElementById("rdio-video").checked)
        applyVideoMode();
    
    document.getElementById("popup-flexbox").addEventListener("click", event => closePopup(event));
    document.getElementById("cancel-btn").addEventListener("click", event => closePopup(event));
    document.getElementById("apply-btn").addEventListener("click", event => onClickDownloadBtn(event));

    let rdio_audio = document.getElementById("rdio-audio");
    let rdio_video = document.getElementById("rdio-video");
    let chk_metadata = document.getElementById("chk-metadata");
    rdio_audio.addEventListener("change", () => applyAudioMode());
    rdio_video.addEventListener("change", () => applyVideoMode());
    chk_metadata.addEventListener("change", () => updateSelMetadataType());

    let v_window = document.defaultView;
    let label_audio = rdio_audio.nextSibling;
    let temp_audio = v_window.getComputedStyle(label_audio).margin;
    label_audio.style.margin = "0px 0px 0px 0px";
    label_audio.style.padding = temp_audio;
    let label_video = rdio_video.nextSibling;
    let temp_video = v_window.getComputedStyle(label_video).margin;
    label_video.style.margin = "0px 0px 0px 0px";
    label_video.style.padding = temp_video;
    let label_metadata = chk_metadata.nextSibling;
    let temp_metadata = v_window.getComputedStyle(label_metadata).margin;
    label_metadata.style.margin = "0px 0px 0px 0px";
    label_metadata.style.padding = temp_metadata;
</script>
